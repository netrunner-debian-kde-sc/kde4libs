#!/usr/bin/make -f

UPSTREAMVERSION ?= $(shell dpkg-parsechangelog | grep '^Version: ' | sed 's/^Version: \(.*\)-.*/\1/')
#UPSTREAMVERSION ?= 4:4.1.3-2
PLASMA_ABI=$(shell grep 'plasma-abi-' debian/libplasma3.symbols.in | head -n1 | sed 's/^.*\(plasma-abi-\S\+\).*/\1/')
RUNTIME_DEPS := kdebase-runtime (>= 4:4.1.80)

DEB_DBG_PACKAGE_kdelibs5 := kdelibs5-dbg
DEB_DBG_PACKAGE_kdelibs-bin := kdelibs5-dbg
DEB_DBG_PACKAGE_libplasma3 := kdelibs5-dbg

DEB_CMAKE_EXTRA_FLAGS += -DKDE4_ENABLE_EXPERIMENTAL_LIB_EXPORT=on

#bump version for every new upstream version!
DEB_DH_MAKESHLIBS_ARGS_kdelibs5 := -V'kdelibs5 (>= $(UPSTREAMVERSION)), $(RUNTIME_DEPS)'
#DEB_DH_MAKESHLIBS_ARGS_libplasma3 := -V'libplasma3 (>= $(UPSTREAMVERSION)), $(PLASMA_ABI)'

# remove dependencies on kdebase-runtime and phonon (the metapackage)
DEB_DH_SHLIBDEPS_ARGS_ALL := -- -xkdebase-runtime -xphonon

include debian/cdbs/kde.mk

binary-predeb/libplasma3::
	echo plasma:abi-provides=$(PLASMA_ABI) >> debian/libplasma3.substvars

binary-strip/libplasma3::
	pkgkde-symbolshelper symbolfile -p $(cdbs_curpkg) -o debian/$(cdbs_curpkg).symbols.$(DEB_HOST_ARCH)

binary-fixup/libplasma3::
	pkgkde-symbolshelper postgensymbols -p $(cdbs_curpkg) -v

clean::
	rm -f debian/libplasma3.symbols.$(DEB_HOST_ARCH)
